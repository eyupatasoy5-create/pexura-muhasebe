<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ã–n Muhasebe Web</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#151720; --muted:#9aa3b2; --text:#e7eaf0;
      --acc:#4f8cff; --acc2:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}
    header{
      position:sticky;top:0;z-index:5;background:rgba(11,12,16,0.9);
      backdrop-filter:blur(8px);border-bottom:1px solid #222632;
      padding:10px 14px;display:flex;gap:8px;align-items:center;
    }
    header h1{font-size:18px;margin:0}
    header .spacer{flex:1}
    header button{
      background:var(--card);color:var(--text);border:1px solid #23283a;
      padding:7px 10px;border-radius:10px;cursor:pointer;
    }

    .authbar{
      padding:8px 14px;border-bottom:1px solid #222632;background:#0e0f15;
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
    }
    .authbar input{
      padding:8px 10px;border-radius:10px;background:#0f1118;border:1px solid #242a3a;
      color:var(--text);outline:none;
    }

    .wrap{display:grid;grid-template-columns:260px 1fr;min-height:calc(100vh - 56px)}
    nav{border-right:1px solid #222632;background:#0e0f15;padding:10px}
    nav .navbtn{
      width:100%;text-align:left;padding:10px 12px;margin:6px 0;background:var(--card);
      border:1px solid #23283a;color:var(--text);border-radius:12px;cursor:pointer;
      display:flex;align-items:center;gap:8px;
    }
    nav .navbtn.active{border-color:var(--acc);box-shadow:0 0 0 1px var(--acc) inset;}
    main{padding:12px;display:grid;gap:12px}

    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .card{
      background:var(--card);border:1px solid #23283a;border-radius:var(--radius);
      padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{font-size:16px;margin:0 0 10px}
    .muted{color:var(--muted);font-size:12px}
    label{font-size:12px;color:var(--muted);display:block;margin:8px 0 4px}
    input,select,textarea{
      width:100%;padding:9px 10px;border-radius:10px;background:#0f1118;
      border:1px solid #242a3a;color:var(--text);outline:none;
    }
    textarea{min-height:70px;resize:vertical}
    .row{display:flex;gap:8px}
    .row>*{flex:1}
    .btn{
      background:var(--acc);border:none;color:white;padding:9px 12px;border-radius:10px;
      cursor:pointer;font-weight:600;
    }
    .btn.secondary{background:#23283a}
    .btn.success{background:var(--acc2)}
    .btn.danger{background:var(--danger)}
    .btn.warn{background:var(--warn);color:#111827}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:8px;border-bottom:1px solid #242a3a;vertical-align:top}
    th{color:#c9d2e3;text-align:left;font-size:12px;letter-spacing:.4px;text-transform:uppercase}
    tr:hover td{background:#101320}
    .tag{
      font-size:11px;padding:3px 8px;border-radius:999px;border:1px solid #2a3146;
      background:#0f1220;color:#cfd6e6;display:inline-block;
    }
    .tag.in{border-color:#1f6feb66;color:#9ecbff}
    .tag.out{border-color:#22c55e66;color:#86efac}
    .tag.exp{border-color:#ef444466;color:#fca5a5}

    .kpi{grid-column:span 3;display:flex;flex-direction:column;gap:4px}
    .kpi .val{font-size:22px;font-weight:700}
    .kpi .label{font-size:12px;color:var(--muted)}
    .hide{display:none!important}

    @media (max-width:900px){
      .wrap{grid-template-columns:1fr}
      nav{display:flex;gap:8px;overflow:auto;position:sticky;top:96px;z-index:4}
      nav .navbtn{white-space:nowrap;width:auto}
      .kpi{grid-column:span 6}
    }
    @media (max-width:520px){
      .kpi{grid-column:span 12}
    }
  </style>
</head>
<body>

<header>
  <h1 id="title">Ã–n Muhasebe Web</h1>
  <div class="spacer"></div>
  <button id="backupBtn">JSON Yedek</button>
</header>

<div class="authbar">
  <div id="authLoggedOut">
    <input id="authEmail" placeholder="E-posta"/>
    <input id="authPass" type="password" placeholder="Åžifre"/>
    <button class="btn secondary" id="btnRegister">KayÄ±t Ol</button>
    <button class="btn" id="btnLogin">GiriÅŸ</button>
  </div>
  <div id="authLoggedIn" class="hide">
    <span id="authUserMail"></span>
    <button class="btn secondary" id="btnLogout">Ã‡Ä±kÄ±ÅŸ</button>
  </div>
  <span class="muted">Not: Veriler buluta kaydolur, her cihazdan aynÄ± hesabÄ± aÃ§Ä±nca gelir.</span>
</div>

<div class="wrap">
  <nav>
    <button class="navbtn active" data-tab="dash">ðŸ“Œ Dashboard</button>
    <button class="navbtn" data-tab="cariler">ðŸ‘¥ Cariler</button>
    <button class="navbtn" data-tab="urunler">ðŸ“¦ ÃœrÃ¼n/Stok</button>
    <button class="navbtn" data-tab="faturalar">ðŸ§¾ Faturalar</button>
    <button class="navbtn" data-tab="kasa">ðŸ’° Kasa/Banka</button>
    <button class="navbtn" data-tab="gelirgider">ðŸ“ˆ Gelir/Gider</button>
    <button class="navbtn" data-tab="raporlar">ðŸ§® Raporlar</button>
  </nav>

  <main>
    <!-- DASH -->
    <section id="tab-dash" class="tab">
      <div class="grid">
        <div class="card kpi">
          <div class="label">Toplam Cari BorÃ§</div><div class="val" id="kpiCariBorc">0</div>
        </div>
        <div class="card kpi">
          <div class="label">Toplam Cari Alacak</div><div class="val" id="kpiCariAlacak">0</div>
        </div>
        <div class="card kpi">
          <div class="label">Toplam Kasa/Banka</div><div class="val" id="kpiKasa">0</div>
        </div>
        <div class="card kpi">
          <div class="label">Bu Ay Net (GG)</div><div class="val" id="kpiNet">0</div>
        </div>
      </div>

      <div class="grid">
        <div class="card" style="grid-column:span 6;">
          <h2>Son Faturalar</h2>
          <table>
            <thead><tr><th>Tarih</th><th>Tip</th><th>Cari</th><th>Toplam</th></tr></thead>
            <tbody id="dashFatura"></tbody>
          </table>
        </div>
        <div class="card" style="grid-column:span 6;">
          <h2>Kritik Stoklar</h2>
          <table>
            <thead><tr><th>ÃœrÃ¼n</th><th>Stok</th><th>Min</th></tr></thead>
            <tbody id="dashStok"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CARILER -->
    <section id="tab-cariler" class="tab hide">
      <div class="grid">
        <div class="card" style="grid-column: span 5;">
          <h2>Cari Ekle</h2>
          <label>TÃ¼r</label>
          <select id="cariTur">
            <option value="musteri">MÃ¼ÅŸteri</option>
            <option value="tedarikci">TedarikÃ§i</option>
            <option value="herikisi">Her ikisi</option>
          </select>
          <label>Ãœnvan / Ad Soyad</label><input id="cariAd"/>
          <div class="row">
            <div><label>Telefon</label><input id="cariTel"/></div>
            <div><label>E-posta</label><input id="cariMail"/></div>
          </div>
          <label>Adres</label><textarea id="cariAdres"></textarea>
          <div class="row">
            <div><label>AÃ§Ä±lÄ±ÅŸ BorÃ§</label><input id="cariABorc" type="number" value="0"/></div>
            <div><label>AÃ§Ä±lÄ±ÅŸ Alacak</label><input id="cariAAlacak" type="number" value="0"/></div>
          </div>
          <button class="btn" id="cariEkleBtn" style="margin-top:10px;">Kaydet</button>
        </div>

        <div class="card" style="grid-column: span 7;">
          <h2>Cari Listesi</h2>
          <table>
            <thead><tr><th>Ãœnvan</th><th>TÃ¼r</th><th>Bakiye</th><th></th></tr></thead>
            <tbody id="cariListe"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- URUNLER -->
    <section id="tab-urunler" class="tab hide">
      <div class="grid">
        <div class="card" style="grid-column: span 5;">
          <h2>ÃœrÃ¼n Ekle</h2>
          <label>Kod</label><input id="uKod"/>
          <label>Ad</label><input id="uAd"/>
          <div class="row">
            <div><label>Birim</label><input id="uBirim" placeholder="Adet/Kg"/></div>
            <div><label>Min Stok</label><input id="uMin" type="number" value="0"/></div>
          </div>
          <div class="row">
            <div><label>AlÄ±ÅŸ Fiyat</label><input id="uAlis" type="number" step="0.01"/></div>
            <div><label>SatÄ±ÅŸ Fiyat</label><input id="uSatis" type="number" step="0.01"/></div>
          </div>
          <label>KDV %</label><input id="uKdv" type="number" value="18"/>
          <button class="btn" id="uKaydetBtn" style="margin-top:10px;">Kaydet</button>
        </div>

        <div class="card" style="grid-column: span 7;">
          <h2>ÃœrÃ¼n/Stok Listesi</h2>
          <table>
            <thead><tr><th>Kod</th><th>Ad</th><th>Stok</th><th>SatÄ±ÅŸ</th><th></th></tr></thead>
            <tbody id="uListe"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- FATURALAR -->
    <section id="tab-faturalar" class="tab hide">
      <div class="grid">
        <div class="card" style="grid-column: span 5;">
          <h2>Fatura OluÅŸtur</h2>
          <label>Tip</label>
          <select id="fTip">
            <option value="satis">SatÄ±ÅŸ</option>
            <option value="alis">AlÄ±ÅŸ</option>
          </select>
          <label>Cari</label><select id="fCari"></select>
          <div class="row">
            <div><label>Tarih</label><input id="fTarih" type="date"/></div>
            <div><label>Numara</label><input id="fNo" placeholder="F-2025-0001"/></div>
          </div>
          <label>Kasa/Banka (peÅŸinse seÃ§)</label><select id="fKasa"></select>
          <hr style="border-color:#242a3a;margin:10px 0">

          <h2>Kalem Ekle</h2>
          <label>ÃœrÃ¼n</label><select id="kUrun"></select>
          <div class="row">
            <div><label>Miktar</label><input id="kMiktar" type="number" step="0.01" value="1"/></div>
            <div><label>Birim Fiyat</label><input id="kFiyat" type="number" step="0.01"/></div>
          </div>
          <div class="row">
            <div><label>KDV %</label><input id="kKdv" type="number" value="18"/></div>
            <div style="align-self:end"><button class="btn secondary" id="kalemEkleBtn">SatÄ±ra Ekle</button></div>
          </div>

          <div style="margin-top:10px">
            <div class="muted">Ara Toplam: <span id="fAra">0</span></div>
            <div class="muted">KDV Toplam: <span id="fKdvTop">0</span></div>
            <div style="font-weight:700;margin-top:4px">Genel Toplam: <span id="fGenel">0</span></div>
          </div>

          <button class="btn success" id="fKaydetBtn" style="margin-top:10px;">FaturayÄ± Kaydet</button>
        </div>

        <div class="card" style="grid-column: span 7;">
          <h2>Fatura Kalemleri</h2>
          <table>
            <thead><tr><th>ÃœrÃ¼n</th><th>Miktar</th><th>Fiyat</th><th>KDV</th><th>Tutar</th><th></th></tr></thead>
            <tbody id="kalemListe"></tbody>
          </table>

          <h2 style="margin-top:12px">Faturalar</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
            <button class="btn secondary" id="fExcelBtn">Excel (Faturalar)</button>
          </div>
          <table>
            <thead><tr><th>Tarih</th><th>Tip</th><th>No</th><th>Cari</th><th>Toplam</th><th></th></tr></thead>
            <tbody id="faturaListe"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- KASA -->
    <section id="tab-kasa" class="tab hide">
      <div class="grid">
        <div class="card" style="grid-column:span 5;">
          <h2>Kasa/Banka HesabÄ± Ekle</h2>
          <label>Ad</label><input id="hAd" placeholder="Kasa 1 / Ziraat IBAN"/>
          <label>TÃ¼r</label>
          <select id="hTur">
            <option value="kasa">Kasa</option>
            <option value="banka">Banka</option>
            <option value="pos">POS</option>
          </select>
          <label>AÃ§Ä±lÄ±ÅŸ Bakiye</label><input id="hAc" type="number" value="0"/>
          <button class="btn" id="hEkleBtn" style="margin-top:10px">Kaydet</button>

          <hr style="border-color:#242a3a;margin:12px 0">

          <h2>Kasa Hareketi</h2>
          <label>Hesap</label><select id="kHesap"></select>
          <label>Tarih</label><input id="kTarih" type="date"/>
          <label>TÃ¼r</label>
          <select id="kTur">
            <option value="tahsilat">Tahsilat</option>
            <option value="odeme">Ã–deme</option>
          </select>
          <label>Cari (opsiyonel)</label><select id="kCari"></select>
          <label>Tutar</label><input id="kTutar" type="number" step="0.01"/>
          <label>AÃ§Ä±klama</label><input id="kAciklama"/>
          <button class="btn success" id="kEkleBtn" style="margin-top:10px">Ekle</button>
        </div>

        <div class="card" style="grid-column:span 7;">
          <h2>Hesaplar</h2>
          <table>
            <thead><tr><th>Ad</th><th>TÃ¼r</th><th>Bakiye</th><th></th></tr></thead>
            <tbody id="hesapListe"></tbody>
          </table>

          <h2 style="margin-top:12px">Hareketler</h2>
          <table>
            <thead><tr><th>Tarih</th><th>Hesap</th><th>TÃ¼r</th><th>Tutar</th><th>Not</th><th></th></tr></thead>
            <tbody id="hareketListe"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GG -->
    <section id="tab-gelirgider" class="tab hide">
      <div class="grid">
        <div class="card" style="grid-column:span 5;">
          <h2>Gelir/Gider Ekle</h2>
          <label>Tarih</label><input id="ggTarih" type="date"/>
          <label>TÃ¼r</label>
          <select id="ggTur">
            <option value="gelir">Gelir</option>
            <option value="gider">Gider</option>
          </select>
          <label>Kategori</label><input id="ggKat" placeholder="Kira / SatÄ±ÅŸ / Reklam"/>
          <label>Tutar</label><input id="ggTutar" type="number" step="0.01"/>
          <label>AÃ§Ä±klama</label><input id="ggAc"/>
          <button class="btn" id="ggEkleBtn" style="margin-top:10px">Kaydet</button>
        </div>

        <div class="card" style="grid-column:span 7;">
          <h2>Liste</h2>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
            <button class="btn secondary" id="ggExcelBtn">Excel (Gelir/Gider)</button>
          </div>
          <table>
            <thead><tr><th>Tarih</th><th>TÃ¼r</th><th>Kategori</th><th>Tutar</th><th>Not</th><th></th></tr></thead>
            <tbody id="ggListe"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RAPOR -->
    <section id="tab-raporlar" class="tab hide">
      <div class="card">
        <h2>Tarih AralÄ±ÄŸÄ± Ã–zet</h2>
        <div class="row">
          <div><label>BaÅŸlangÄ±Ã§</label><input id="rBas" type="date"/></div>
          <div><label>BitiÅŸ</label><input id="rBit" type="date"/></div>
          <div style="align-self:end"><button class="btn" id="rHesaplaBtn">Hesapla</button></div>
        </div>
        <div class="grid" style="margin-top:10px">
          <div class="card kpi" style="grid-column:span 4">
            <div class="label">Gelir</div><div class="val" id="rGelir">0</div>
          </div>
          <div class="card kpi" style="grid-column:span 4">
            <div class="label">Gider</div><div class="val" id="rGider">0</div>
          </div>
          <div class="card kpi" style="grid-column:span 4">
            <div class="label">Net</div><div class="val" id="rNet">0</div>
          </div>
        </div>
      </div>
    </section>

  </main>
</div>

<!-- KÃœTÃœPHANELER -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
/* =========================
   1) SUPABASE BAÄžLANTISI
========================= */
const SUPABASE_URL = "BURAYA_SUPABASE_URL";
const SUPABASE_ANON_KEY = "BURAYA_ANON_KEY";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   2) GLOBAL STATE
========================= */
let USER = null;
let CARILER=[], URUNLER=[], HESAPLAR=[], HAREKETLER=[], GG=[], FATURALAR=[];
const fmt = (n)=> (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}) + " â‚º";
const todayStr = ()=> new Date().toISOString().slice(0,10);

/* =========================
   3) AUTH
========================= */
async function register(){
  const email = authEmail.value.trim();
  const password = authPass.value.trim();
  const { error } = await supa.auth.signUp({ email, password });
  if(error) return alert(error.message);
  alert("KayÄ±t oldu. E-postanÄ± doÄŸrulayÄ±p giriÅŸ yap.");
}

async function login(){
  const email = authEmail.value.trim();
  const password = authPass.value.trim();
  const { error } = await supa.auth.signInWithPassword({ email, password });
  if(error) return alert(error.message);
  await loadSession();
}

async function logout(){
  await supa.auth.signOut();
  location.reload();
}

async function loadSession(){
  const { data } = await supa.auth.getUser();
  USER = data.user;
  if(USER){
    authLoggedOut.classList.add("hide");
    authLoggedIn.classList.remove("hide");
    authUserMail.textContent = USER.email;
    await fetchAll();
  }
}
btnRegister.onclick=register;
btnLogin.onclick=login;
btnLogout.onclick=logout;

/* =========================
   4) FETCH ALL
========================= */
async function fetchAll(){
  await Promise.all([
    fetchCariler(),
    fetchUrunler(),
    fetchHesaplar(),
    fetchHareketler(),
    fetchGG(),
    fetchFaturalar()
  ]);
  fillSelects();
  renderAll();
}

/* -------------------------
   CARILER
------------------------- */
async function fetchCariler(){
  const { data, error } = await supa.from("cariler").select("*").order("ad");
  if(error) console.error(error);
  CARILER = data||[];
}
cariEkleBtn.onclick = async ()=>{
  if(!cariAd.value.trim()) return alert("Cari adÄ± zorunlu");
  const payload = {
    user_id: USER.id,
    tur: cariTur.value,
    ad: cariAd.value.trim(),
    tel: cariTel.value.trim(),
    mail: cariMail.value.trim(),
    adres: cariAdres.value.trim(),
    acilis_borc: Number(cariABorc.value||0),
    acilis_alacak: Number(cariAAlacak.value||0),
  };
  const { error } = await supa.from("cariler").insert(payload);
  if(error) return alert(error.message);
  cariAd.value=""; cariTel.value=""; cariMail.value="";
  cariAdres.value=""; cariABorc.value=0; cariAAlacak.value=0;
  await fetchCariler(); fillSelects(); renderCariler(); renderDash();
};
function cariBakiye(c){
  let b = Number(c.acilis_borc||0) - Number(c.acilis_alacak||0);
  HAREKETLER.filter(h=>h.cari_id===c.id).forEach(h=>{
    if(h.tur==="tahsilat") b -= Number(h.tutar||0);
    if(h.tur==="odeme") b += Number(h.tutar||0);
  });
  return b;
}
function renderCariler(){
  cariListe.innerHTML="";
  CARILER.forEach(c=>{
    const b = cariBakiye(c);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${c.ad}<div class="muted">${c.tel||""}</div></td>
      <td><span class="tag">${c.tur}</span></td>
      <td>${fmt(b)}</td>
      <td><button class="btn secondary" data-del="${c.id}">Sil</button></td>`;
    cariListe.appendChild(tr);
  });
  cariListe.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm("Silinsin mi?")) return;
      await supa.from("cariler").delete().eq("id", btn.dataset.del);
      await fetchCariler(); fillSelects(); renderCariler(); renderDash();
    };
  });
}

/* -------------------------
   URUNLER / STOK
------------------------- */
async function fetchUrunler(){
  const { data, error } = await supa.from("urunler").select("*").order("ad");
  if(error) console.error(error);
  URUNLER = data||[];
}
uKaydetBtn.onclick = async ()=>{
  if(!uAd.value.trim()) return alert("ÃœrÃ¼n adÄ± zorunlu");
  const payload={
    user_id: USER.id,
    kod: uKod.value.trim(),
    ad: uAd.value.trim(),
    birim: uBirim.value.trim(),
    min_stok: Number(uMin.value||0),
    alis_fiyat: Number(uAlis.value||0),
    satis_fiyat: Number(uSatis.value||0),
    kdv_oran: Number(uKdv.value||18),
    stok_miktar: 0
  };
  const { error }=await supa.from("urunler").insert(payload);
  if(error) return alert(error.message);
  uKod.value="";uAd.value="";uBirim.value="";uMin.value=0;
  uAlis.value="";uSatis.value="";uKdv.value=18;
  await fetchUrunler(); fillSelects(); renderUrunler(); renderDash();
};
function renderUrunler(){
  uListe.innerHTML="";
  URUNLER.forEach(u=>{
    const krit = Number(u.stok_miktar||0) <= Number(u.min_stok||0);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${u.kod||""}</td>
      <td>${u.ad} ${krit?'<span class="tag exp">Kritik</span>':""}</td>
      <td>${u.stok_miktar} ${u.birim||""}</td>
      <td>${fmt(u.satis_fiyat)}</td>
      <td><button class="btn secondary" data-del="${u.id}">Sil</button></td>`;
    uListe.appendChild(tr);
  });
  uListe.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm("Silinsin mi?")) return;
      await supa.from("urunler").delete().eq("id", btn.dataset.del);
      await fetchUrunler(); fillSelects(); renderUrunler(); renderDash();
    };
  });
}

/* -------------------------
   KASA / BANKA
------------------------- */
async function fetchHesaplar(){
  const { data, error } = await supa.from("kasa_hesaplar").select("*").order("ad");
  if(error) console.error(error);
  HESAPLAR = data||[];
}
hEkleBtn.onclick = async ()=>{
  if(!hAd.value.trim()) return alert("Hesap adÄ± zorunlu");
  const payload={
    user_id: USER.id,
    ad: hAd.value.trim(),
    tur: hTur.value,
    acilis_bakiye: Number(hAc.value||0)
  };
  const { error }=await supa.from("kasa_hesaplar").insert(payload);
  if(error) return alert(error.message);
  hAd.value="";hTur.value="kasa";hAc.value=0;
  await fetchHesaplar(); fillSelects(); renderHesaplar(); renderDash();
};

async function fetchHareketler(){
  const { data, error }=await supa.from("kasa_hareketler").select("*").order("tarih",{ascending:false});
  if(error) console.error(error);
  HAREKETLER=data||[];
}
kEkleBtn.onclick = async ()=>{
  if(!kHesap.value) return alert("Hesap seÃ§");
  const tut=Number(kTutar.value||0);
  if(!tut||tut<=0) return alert("Tutar gir");
  const payload={
    user_id: USER.id,
    hesap_id: kHesap.value,
    tarih: kTarih.value || todayStr(),
    tur: kTur.value,
    cari_id: kCari.value || null,
    tutar: tut,
    aciklama: kAciklama.value.trim()
  };
  const { error }=await supa.from("kasa_hareketler").insert(payload);
  if(error) return alert(error.message);
  kTutar.value="";kAciklama.value="";
  await fetchHareketler(); renderHareketler(); renderHesaplar(); renderDash();
};

function hesapBakiye(h){
  let b=Number(h.acilis_bakiye||0);
  HAREKETLER.filter(x=>x.hesap_id===h.id).forEach(x=>{
    b += (x.tur==="tahsilat"? Number(x.tutar||0) : -Number(x.tutar||0));
  });
  return b;
}
function renderHesaplar(){
  hesapListe.innerHTML="";
  HESAPLAR.forEach(h=>{
    const b=hesapBakiye(h);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${h.ad}</td>
      <td><span class="tag">${h.tur}</span></td>
      <td>${fmt(b)}</td>
      <td><button class="btn secondary" data-del="${h.id}">Sil</button></td>`;
    hesapListe.appendChild(tr);
  });
  hesapListe.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm("Silinsin mi?")) return;
      await supa.from("kasa_hesaplar").delete().eq("id", btn.dataset.del);
      await fetchHesaplar(); fillSelects(); renderHesaplar(); renderDash();
    };
  });
}
function renderHareketler(){
  hareketListe.innerHTML="";
  HAREKETLER.forEach(h=>{
    const hesap=HESAPLAR.find(x=>x.id===h.hesap_id);
    const cari=CARILER.find(x=>x.id===h.cari_id);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${h.tarih}</td>
      <td>${hesap?hesap.ad:""}</td>
      <td><span class="tag ${h.tur==="tahsilat"?"out":"exp"}">${h.tur}</span></td>
      <td>${fmt(h.tutar)}</td>
      <td>${(cari?cari.ad+" â€¢ ":"")+(h.aciklama||"")}</td>
      <td><button class="btn secondary" data-del="${h.id}">Sil</button></td>`;
    hareketListe.appendChild(tr);
  });
  hareketListe.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm("Silinsin mi?")) return;
      await supa.from("kasa_hareketler").delete().eq("id", btn.dataset.del);
      await fetchHareketler(); renderHareketler(); renderHesaplar(); renderDash();
    };
  });
}

/* -------------------------
   GELIR / GIDER
------------------------- */
async function fetchGG(){
  const { data, error }=await supa.from("gelir_gider").select("*").order("tarih",{ascending:false});
  if(error) console.error(error);
  GG=data||[];
}
ggEkleBtn.onclick=async ()=>{
  const tut=Number(ggTutar.value||0);
  if(!tut||tut<=0) return alert("Tutar gir");
  const payload={
    user_id: USER.id,
    tarih: ggTarih.value||todayStr(),
    tur: ggTur.value,
    kategori: ggKat.value.trim()||"Genel",
    tutar: tut,
    aciklama: ggAc.value.trim()
  };
  const { error }=await supa.from("gelir_gider").insert(payload);
  if(error) return alert(error.message);
  ggKat.value="";ggTutar.value="";ggAc.value="";
  await fetchGG(); renderGG(); renderDash();
};
function renderGG(){
  ggListe.innerHTML="";
  GG.forEach(g=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${g.tarih}</td>
      <td><span class="tag ${g.tur==="gelir"?"out":"exp"}">${g.tur}</span></td>
      <td>${g.kategori}</td>
      <td>${fmt(g.tutar)}</td>
      <td>${g.aciklama||""}</td>
      <td><button class="btn secondary" data-del="${g.id}">Sil</button></td>`;
    ggListe.appendChild(tr);
  });
  ggListe.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm("Silinsin mi?")) return;
      await supa.from("gelir_gider").delete().eq("id", btn.dataset.del);
      await fetchGG(); renderGG(); renderDash();
    };
  });
}

/* -------------------------
   FATURALAR
------------------------- */
let FATURA_SATIRLAR=[];
async function fetchFaturalar(){
  const { data, error }=await supa.from("faturalar").select("*").order("tarih",{ascending:false});
  if(error) console.error(error);
  FATURALAR=data||[];
}

kalemEkleBtn.onclick=()=>{
  const urun=URUNLER.find(u=>u.id===kUrun.value);
  if(!urun) return alert("ÃœrÃ¼n seÃ§");
  const mikt=Number(kMiktar.value||0);
  const fiyat=Number(kFiyat.value||urun.satis_fiyat||0);
  const kdv=Number(kKdv.value||urun.kdv_oran||18);
  if(mikt<=0) return alert("Miktar gir");
  const ara=mikt*fiyat;
  const kdvT=ara*kdv/100;
  const satirT=ara+kdvT;

  FATURA_SATIRLAR.push({
    urun_id: urun.id,
    urun_ad: urun.ad,
    miktar: mikt,
    birim_fiyat: fiyat,
    kdv_oran: kdv,
    satir_tutar: satirT
  });
  renderKalemler();
  calcFaturaTotals();
};

function renderKalemler(){
  kalemListe.innerHTML="";
  FATURA_SATIRLAR.forEach((s,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${s.urun_ad}</td>
      <td>${s.miktar}</td>
      <td>${fmt(s.birim_fiyat)}</td>
      <td>%${s.kdv_oran}</td>
      <td>${fmt(s.satir_tutar)}</td>
      <td><button class="btn secondary" data-i="${i}">Sil</button></td>`;
    kalemListe.appendChild(tr);
  });
  kalemListe.querySelectorAll("[data-i]").forEach(btn=>{
    btn.onclick=()=>{
      FATURA_SATIRLAR.splice(Number(btn.dataset.i),1);
      renderKalemler(); calcFaturaTotals();
    };
  });
}

function calcFaturaTotals(){
  let ara=0,kdv=0,genel=0;
  FATURA_SATIRLAR.forEach(s=>{
    const satirAra = s.miktar*s.birim_fiyat;
    const satirKdv = satirAra*s.kdv_oran/100;
    ara += satirAra;
    kdv += satirKdv;
    genel += satirAra+satirKdv;
  });
  fAra.textContent=fmt(ara);
  fKdvTop.textContent=fmt(kdv);
  fGenel.textContent=fmt(genel);
  return {ara,kdv,genel};
}

fKaydetBtn.onclick=async ()=>{
  if(!fCari.value) return alert("Cari seÃ§");
  if(FATURA_SATIRLAR.length===0) return alert("Kalem ekle");
  const totals=calcFaturaTotals();

  const { data: inserted, error: fErr }=await supa.from("faturalar").insert({
    user_id: USER.id,
    tip: fTip.value,
    cari_id: fCari.value,
    tarih: fTarih.value||todayStr(),
    numara: fNo.value.trim()||("F-"+Date.now()),
    ara_toplam: totals.ara,
    kdv_toplam: totals.kdv,
    genel_toplam: totals.genel,
    kasa_hesap_id: fKasa.value||null
  }).select().single();
  if(fErr) return alert(fErr.message);

  const kalemPayload = FATURA_SATIRLAR.map(s=>({
    fatura_id: inserted.id,
    urun_id: s.urun_id,
    miktar: s.miktar,
    birim_fiyat: s.birim_fiyat,
    kdv_oran: s.kdv_oran,
    satir_tutar: s.satir_tutar
  }));
  const { error: kErr }=await supa.from("fatura_kalemler").insert(kalemPayload);
  if(kErr) return alert(kErr.message);

  for(const s of FATURA_SATIRLAR){
    const degisim = fTip.value==="satis" ? -s.miktar : +s.miktar;
    await supa.rpc("stok_guncelle",{p_urun_id:s.urun_id,p_degisim:degisim});
  }

  if(fKasa.value){
    await supa.from("kasa_hareketler").insert({
      user_id: USER.id,
      hesap_id: fKasa.value,
      tarih: fTarih.value||todayStr(),
      tur: fTip.value==="satis"?"tahsilat":"odeme",
      cari_id: fCari.value,
      tutar: totals.genel,
      aciklama: (fTip.value==="satis"?"SatÄ±ÅŸ":"AlÄ±ÅŸ")+" faturasÄ± "+inserted.numara
    });
  }

  alert("Fatura kaydedildi");
  FATURA_SATIRLAR=[];
  renderKalemler(); calcFaturaTotals();

  await fetchFaturalar();
  await fetchUrunler();
  await fetchHareketler();

  fillSelects();
  renderFaturalar();
  renderUrunler();
  renderHareketler();
  renderHesaplar();
  renderDash();
};

function renderFaturalar(){
  faturaListe.innerHTML="";
  FATURALAR.forEach(f=>{
    const cari=CARILER.find(c=>c.id===f.cari_id);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${f.tarih}</td>
      <td><span class="tag ${f.tip==="satis"?"out":"in"}">${f.tip}</span></td>
      <td>${f.numara}</td>
      <td>${cari?cari.ad:""}</td>
      <td>${fmt(f.genel_toplam)}</td>
      <td>
        <button class="btn secondary" data-pdf="${f.id}">PDF</button>
        <button class="btn secondary" data-del="${f.id}">Sil</button>
      </td>`;
    faturaListe.appendChild(tr);
  });

  faturaListe.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick=async ()=>{
      if(!confirm("Fatura silinsin mi? (stok geri alÄ±nmaz)")) return;
      await supa.from("faturalar").delete().eq("id", btn.dataset.del);
      await fetchFaturalar(); renderFaturalar(); renderDash();
    };
  });

  faturaListe.querySelectorAll("[data-pdf]").forEach(btn=>{
    btn.onclick=()=> exportFaturaPDF(btn.dataset.pdf);
  });
}

/* -------------------------
   PDF EXPORT (jsPDF)
------------------------- */
async function exportFaturaPDF(faturaId){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const { data: f, error } = await supa
    .from("faturalar")
    .select("*, cariler(ad), fatura_kalemler(*, urunler(ad))")
    .eq("id", faturaId)
    .single();
  if(error) return alert(error.message);

  doc.setFontSize(16);
  doc.text("FATURA", 10, 12);
  doc.setFontSize(11);
  doc.text("No: " + f.numara, 10, 22);
  doc.text("Tarih: " + f.tarih, 10, 29);
  doc.text("Cari: " + (f.cariler?.ad || ""), 10, 36);
  doc.text("Tip: " + f.tip, 10, 43);

  let y=55;
  doc.text("Kalemler:", 10, y); y+=6;
  f.fatura_kalemler.forEach(k=>{
    const ad = k.urunler?.ad || "";
    doc.text(`${ad} | ${k.miktar} x ${k.birim_fiyat} | KDV %${k.kdv_oran} | ${k.satir_tutar}`, 10, y);
    y+=6; if(y>280){ doc.addPage(); y=10; }
  });

  y+=6;
  doc.text("Ara: " + f.ara_toplam, 10, y); y+=6;
  doc.text("KDV: " + f.kdv_toplam, 10, y); y+=6;
  doc.setFontSize(13);
  doc.text("Genel Toplam: " + f.genel_toplam, 10, y);

  doc.save("fatura_" + f.numara + ".pdf");
}

/* -------------------------
   EXCEL EXPORT (SheetJS)
------------------------- */
ggExcelBtn.onclick = exportGGExcel;
fExcelBtn.onclick = exportFaturaExcel;

function exportGGExcel(){
  const rows = GG.map(r=>({
    Tarih:r.tarih, Tur:r.tur, Kategori:r.kategori, Tutar:r.tutar, Aciklama:r.aciklama
  }));
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "GelirGider");
  XLSX.writeFile(wb, "gelirgider.xlsx");
}

function exportFaturaExcel(){
  const rows = FATURALAR.map(f=>{
    const cari=CARILER.find(c=>c.id===f.cari_id);
    return {
      Tarih:f.tarih, Tip:f.tip, No:f.numara, Cari:cari?cari.ad:"", Ara:f.ara_toplam,
      KDV:f.kdv_toplam, Toplam:f.genel_toplam
    };
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Faturalar");
  XLSX.writeFile(wb, "faturalar.xlsx");
}

/* -------------------------
   DASH / RAPOR
------------------------- */
function renderDash(){
  let borc=0,alacak=0;
  CARILER.forEach(c=>{
    const b=cariBakiye(c);
    if(b>0) borc+=b; else alacak+=Math.abs(b);
  });
  kpiCariBorc.textContent=fmt(borc);
  kpiCariAlacak.textContent=fmt(alacak);

  let kasaTop=0;
  HESAPLAR.forEach(h=>kasaTop+=hesapBakiye(h));
  kpiKasa.textContent=fmt(kasaTop);

  const ay = new Date().toISOString().slice(0,7);
  let g=0,gi=0;
  GG.filter(x=>x.tarih.startsWith(ay)).forEach(x=>{
    if(x.tur==="gelir") g+=Number(x.tutar||0); else gi+=Number(x.tutar||0);
  });
  kpiNet.textContent=fmt(g-gi);

  dashFatura.innerHTML="";
  FATURALAR.slice(0,5).forEach(f=>{
    const cari=CARILER.find(c=>c.id===f.cari_id);
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${f.tarih}</td><td>${f.tip}</td><td>${cari?cari.ad:""}</td><td>${fmt(f.genel_toplam)}</td>`;
    dashFatura.appendChild(tr);
  });

  dashStok.innerHTML="";
  URUNLER.filter(u=>Number(u.stok_miktar)<=Number(u.min_stok)).slice(0,8).forEach(u=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${u.ad}</td><td>${u.stok_miktar}</td><td>${u.min_stok}</td>`;
    dashStok.appendChild(tr);
  });
}

rHesaplaBtn.onclick=()=>{
  const bas=rBas.value||"0000-01-01";
  const bit=rBit.value||"9999-12-31";
  let g=0,gi=0;
  GG.filter(x=>x.tarih>=bas && x.tarih<=bit).forEach(x=>{
    if(x.tur==="gelir") g+=Number(x.tutar||0); else gi+=Number(x.tutar||0);
  });
  rGelir.textContent=fmt(g);
  rGider.textContent=fmt(gi);
  rNet.textContent=fmt(g-gi);
};

/* -------------------------
   SELECT DOLDURMA
------------------------- */
function fillSelects(){
  fCari.innerHTML = `<option value="">SeÃ§</option>` + CARILER.map(c=>`<option value="${c.id}">${c.ad}</option>`).join("");
  kCari.innerHTML = `<option value="">SeÃ§me</option>` + CARILER.map(c=>`<option value="${c.id}">${c.ad}</option>`).join("");

  kUrun.innerHTML = `<option value="">SeÃ§</option>` + URUNLER.map(u=>`<option value="${u.id}" data-f="${u.satis_fiyat}" data-k="${u.kdv_oran}">${u.ad}</option>`).join("");

  fKasa.innerHTML = `<option value="">PeÅŸin deÄŸil</option>` + HESAPLAR.map(h=>`<option value="${h.id}">${h.ad}</option>`).join("");
  kHesap.innerHTML = `<option value="">SeÃ§</option>` + HESAPLAR.map(h=>`<option value="${h.id}">${h.ad}</option>`).join("");

  kUrun.onchange=()=>{
    const opt = kUrun.selectedOptions[0];
    if(!opt) return;
    kFiyat.value = opt.dataset.f || "";
    kKdv.value = opt.dataset.k || 18;
  };
}

/* -------------------------
   RENDER ALL
------------------------- */
function renderAll(){
  renderCariler();
  renderUrunler();
  renderHesaplar();
  renderHareketler();
  renderGG();
  renderFaturalar();
  renderDash();
}

/* -------------------------
   TABS
------------------------- */
document.querySelectorAll(".navbtn").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".navbtn").forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const tab=b.dataset.tab;
    document.querySelectorAll(".tab").forEach(t=>t.classList.add("hide"));
    document.getElementById("tab-"+tab).classList.remove("hide");
  };
});

/* -------------------------
   BACKUP (JSON)
------------------------- */
backupBtn.onclick=()=>{
  const data={CARILER,URUNLER,HESAPLAR,HAREKETLER,GG,FATURALAR,exportedAt:new Date().toISOString()};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="onmuhasebe_yedek.json";
  a.click();
};

/* INIT */
fTarih.value=todayStr();
kTarih.value=todayStr();
ggTarih.value=todayStr();
rBas.value=todayStr().slice(0,8)+"01";
rBit.value=todayStr();
loadSession();
</script>
</body>
</html>
